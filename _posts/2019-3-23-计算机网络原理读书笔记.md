---
layout:     post
title:      "计算机网络原理读书笔记"
subtitle:   ""
date:       2019-03-21 13:00:00
author:     "Cfeng"
header-img: "img/post-bg-js-module.jpg"
catalog: true
tags:
    - 计算机网络
---
# 概述
## 互联网
网络把主机连接起来，而互联网是把多种不同的网络连接起来，因此互联网是网络的网络。  
## 主机间的通信方式
* 客户-服务器（C/S）：客户是服务的请求方，服务器是服务的提供方。
* 对等（P2P）：不区分客户和服务器。
## 具有五层协议的体系结构
* 应用层 通过应用进程间的交互来完成特定网络应用，例如 HTTP、DNS 等协议。数据单位为报文。
* 运输层 负责两个主机中进程之间的通信提供通用的数据传输服务 TCP/UDP
* 网络层 负责为分组交换网上的不同主机提供通信服务 路由器的最高层
* 数据链路层 将网络层交下来的IP数据报组装成帧，在两个相邻结点间的链路上传送帧
* 物理层 传输的是比特流。
在TCP/IP的四层协议，数据链路层+物理层称为网络接口层
数据在各层之间的传递过程，在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部。
路由器只有下面三层协议，因为路由器位于网络核心中，不需要为进程或者应用程序提供服务，因此也就不需要传输层和应用层。

传输控制协议TCP，提供面向连接的、可靠的数据传输服务、其数据传输的单位是**报文段**。
用户数据协议UDP，提供无连接的，尽最大努力的数据传输服务，其数据传输的单位是**用户数据报**。
***
# 物理层
* 机械特性
* 电气特性
* 功能特性
* 过程特性

## 三种通信方式
单工通信：单向传输
半双工通信：双向交替传输
全双工通信：双向同时传输

## 四种编码方式
![编码方式](https://baike.baidu.com/pic/%E4%B8%8D%E5%BD%92%E9%9B%B6/5922990/0/203fb80e7bec54e746cf281ab0389b504fc26a96?fr=lemma&ct=single#aid=0&pic=203fb80e7bec54e746cf281ab0389b504fc26a96)
## 信道复用技术
1. 频分复用 频分复用的所有主机在相同的时间占用不同的频率带宽资源。
2. 时分复用 时分复用的所有主机在不同的时间占用相同的频率带宽资源。
3. 统计时分复用 是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送。
4. 波分复用 光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波。
5. 码分复用

***
# 数据链路层
## 点对点信道
* 一对一通信。因为不会发生碰撞，因此也比较简单，使用 PPP 协议进行控制。

### 基本问题
1. 封装成帧
将网络层传下来的分组添加首部和尾部，用于标记帧的开始和结束。
2. 透明传输
透明表示一个实际存在的事物看起来好像不存在一样。
帧使用首部和尾部进行定界，如果<u>帧的数据部分含有和首部尾部相同的内容</u>，那么帧的开始和结束位置就会被错误的判定。需要在数据部分出现首部尾部相同的内容前面插入转义字符。如果数据部分出现转义字符，那么就在转义字符前面再加个转义字符。在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。
3. 差错检测
目前数据链路层广泛使用了循环冗余检验（CRC）来检查比特差错。
循环冗余校验同其他差错检测方式一样，通过在要传输的k比特数据D后添加(n-k)比特冗余位(又称帧检验序列，Frame Check Sequence，FCS)F形成n比特的传输帧T，再将其发送出去。
特别的，循环冗余校验提供一个预先设定的(n-k+1)比特整数P，并且要求添加的(n-k)比特F满足：
T mod P == 0
其中 T =2^(n-k)*D + F
基于上述要求，实际应用时，发送方和接收方按以下方式通信：
1.发送方和接收方在通信前，约定好预设整数P。
2.发送方在发送前根据数据D确定满足(1)式的F，生成CRC码 T，T 即为数据位D与校验位F的拼接，发送T。
### 点对点协议PPP协议
* 互联网用户通常需要连接到某个 ISP 之后才能接入到互联网，PPP 协议是用户计算机和 ISP 进行通信时所使用的数据链路层协议。

PPP 的帧格式：
* F 字段为帧的定界符
* A 和 C 字段暂时没有意义
* FCS 字段是使用 CRC 的检验序列
* 信息部分的长度不超过 1500
![ppp帧格式](http://www.023wg.com/message/message/image/PPP-format.png)

##  广播信道
* 一对多通信，一个节点发送的数据能够被广播信道上所有的节点接收到。所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（冲突也叫碰撞）。主要有两种控制方法进行协调，一个是使用信道复用技术，一是使用 CSMA/CD 协议。
### CSMA/CD 协议
CSMA/CD 表示载波监听多点接入 / 碰撞检测。
* 多点接入 ：说明这是总线型网络，许多主机以多点的方式连接到总线上。
* 载波监听 ：每个主机都必须不停地监听信道。在发送前，如果监听到信道正在使用，就必须等待。
* 碰撞检测 ：在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了碰撞。虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞。

---记端到端的传播时延为 τ，最先发送的站点最多经过 2τ 就可以知道是否发生了碰撞，称 2τ 为争用期（51.2微秒）。只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞。
---当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用截断二进制指数退避算法来确定。从离散的整数集合 {0, 1, .., (2k-1)} 中随机取出一个数，记作 r，然后取 r 倍的争用期作为重传等待时间。
---k=MIN [重传次数，10]，重传16次不成功即丢弃改帧。
1. 准备发送：必须先检测信道
2. 检测信道：一直检测直到为空或16次
3. 在发送过程中仍不停检测信道，边发送边监听

***
# 网络层
因为网络层是整个互联网的核心，因此应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。
使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。
与 IP 协议配套使用的还有三个协议：
* 地址解析协议 ARP（Address Resolution Protocol）
* 网际控制报文协议 ICMP（Internet Control Message Protocol）
* 网际组管理协议 IGMP（Internet Group Management Protocol）
## IP数据报格式
![ip数据报格式](https://akaedu.github.io/book/images/tcpip.ipformat.png)
* 版本 : 有 4（IPv4）和 6（IPv6）两个值；
* 首部长度 : 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为首部固定长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。
* 区分服务 : 用来获得更好的服务，一般情况下不使用。
* 总长度 : 包括首部长度和数据部分长度。
* 生存时间 ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。
* 协议 ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。
* 首部检验和 ：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。
* 标识 : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
* 片偏移 : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

***
# 传输层
* 网络层只把分组发送到目的主机，但是真正通信的并不是主机而是主机中的进程。传输层提供了进程间的逻辑通信，传输层向高层用户屏蔽了下面网络层的核心细节，使应用程序看起来像是在两个传输层实体之间有一条端到端的逻辑通信信道。
## UDP和TCP的特点
* 用户数据报协议 UDP（User Datagram Protocol）是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部），支持一对一、一对多、多对一和多对多的交互通信。

* 传输控制协议 TCP（Transmission Control Protocol）是面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块），每一条 TCP 连接只能是点对点的（一对一）。
## TCP的三次握手
假设 A 为客户端，B 为服务器端。
* 首先 B 处于 LISTEN（监听）状态，等待客户的连接请求。
* A 向 B 发送连接请求报文，SYN=1，ACK=0，选择一个初始的序号 x。
* B 收到连接请求报文，如果同意建立连接，则向 A 发送连接确认报文，SYN=1，ACK=1，确认号为 x+1，同时也选择一个初始的序号 y。
* A 收到 B 的连接确认报文后，还要向 B 发出确认，确认号为 y+1，序号为 x+1。
* B 收到 A 的确认后，连接建立。
### 三次握手的原因
第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。
客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。

## TCP的四次挥手
以下描述不讨论序号和确认号，因为序号和确认号的规则比较简单。并且不讨论 ACK，因为 ACK 在连接建立之后都为 1。
* A 发送连接释放报文，FIN=1。
* B 收到之后发出确认，此时 TCP 属于半关闭状态，B 能向 A 发送数据但是 A 不能向 B 发送数据。
* 当 B 不再需要连接时，发送连接释放报文，FIN=1。
* A 收到后发出确认，进入 TIME-WAIT 状态，等待 2 MSL（最大报文存活时间）后释放连接。
* B 收到 A 的确认后释放连接。

![三次握手](https://images2015.cnblogs.com/blog/816045/201611/816045-20161105220355065-482198403.png)

### 四次挥手的原因
客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。

### TIME_WAIT
客户端接收到服务器端的 FIN 报文后进入此状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间 2MSL。这么做有两个理由：
* 确保最后一个确认报文能够到达。如果 B 没收到 A 发送来的确认报文，那么就会重新发送连接释放请求报文，A 等待一段时间就是为了处理这种情况的发生。
* 等待一段时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文。
## TCP流量控制
流量控制是为了控制发送方发送速率，保证接收方来得及接收。
接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 0，则发送方不能发送数据。
## TCP拥塞控制
如果网络出现拥塞，分组将会丢失，此时发送方会继续重传，从而导致网络拥塞程度更高。因此当出现拥塞时，应当控制发送方的速率。这一点和流量控制很像，但是出发点不同。流量控制是为了让接收方能来得及接收，而拥塞控制是为了降低整个网络的拥塞程度。
***
# 应用层
## 文件传送协议
FTP 使用 TCP 进行连接，它需要两个连接来传送一个文件：
* 控制连接：服务器打开端口号21等待客户端的连接，客户端主动建立连接后，使用这个连接将客户端的命令传送给服务器，并传回服务器的应答。
* 数据连接：用来传送一个文件数据。

根据数据连接是否是服务器端主动建立，FTP 有主动和被动两种模式：
* 主动模式：服务器端主动建立数据连接，其中服务器端的端口号为 20，客户端的端口号随机，但是必须大于 1024，因为 0~1023 是熟知端口号。
* 被动模式：客户端主动建立数据连接，其中客户端的端口号由客户端自己指定，服务器端的端口号随机

主动模式要求客户端开放端口号给服务器端，需要去配置客户端的防火墙。被动模式只需要服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。
## 常用端口
| 应用 | 应用层协议 | 端口号 | 传输层协议 | 备注 |
| ------ | ------ | ------ | ------ | ------ |
| 域名解析|DNS| 53| UDP/TCP	| 长度超过 512 字节时使用 TCP| 
| 动态主机配置协议| DHCP| 67/68| UDP| | 	
| 简单网络管理协议| SNMP| 161/162| UDP| | 	
| 文件传送协议|	FTP| 20/21| TCP| 控制连接 21，数据连接 20| 
| 远程终端协议|	TELNET| 23| TCP	| | 
| 超文本传送协议|	HTTP| 80| TCP| | 
| 简单邮件传送协议|	SMTP| 25| TCP| | 
| 邮件读取协议|	POP3| 110| TCP| | 
| 网际报文存取协议|	IMAP| 143| TCP||  





